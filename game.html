<!DOCTYPE html>
<html>
<head> 
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <title>ëŠ˜ë´„ ì´ì•¼ê¸°: ì‚¬ê³„ì ˆì˜ ë¹„ë°€</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sun-typeface/SUITE/fonts/variable/woff2/SUITE-Variable.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root {
      --bg-gradient-start: #e0e7ff;
      --bg-gradient-mid: #c7d2fe;
      --bg-gradient-end: #a5b4fc;
      --primary-text: #1e1b4b;
      --secondary-text: #4338ca;
      --highlight-color: #6366f1;
      --story-header-start: #667eea;
      --story-header-end: #764ba2;
    }

    body { 
      font-family: 'SUITE Variable', sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
      transition: background 1.5s ease;
    }
    
    body.true-ending-theme {
      --bg-gradient-start: #fce7f3;
      --bg-gradient-mid: #fbcfe8;
      --bg-gradient-end: #f9a8d4;
      --primary-text: #581c87;
      --secondary-text: #9d174d;
      --highlight-color: #ec4899;
      --story-header-start: #f472b6;
      --story-header-end: #fbbf24;
    }

    /* ê²Œì„ ìŠ¤í…Œì´ì§€ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .stage {
      transition: opacity 0.8s ease, transform 0.8s ease;
      will-change: transform, opacity;
    }
    .stage.hidden {
      display: none;
    }
    .stage-locked::after {
      content: 'ğŸ”’';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5rem;
      color: var(--highlight-color);
      border-radius: 1.5rem;
      z-index: 10;
      transition: all 0.5s ease;
    }
    .stage-unlocked::after {
      opacity: 0;
      pointer-events: none;
    }

    /* íŒŒí‹°í´ íš¨ê³¼ */
    .sparkle {
      position: absolute;
      background: var(--highlight-color);
      border-radius: 50%;
      pointer-events: none;
      animation: sparkle-anim 0.8s forwards;
    }
    @keyframes sparkle-anim {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5) translate(var(--tx), var(--ty)); opacity: 0; }
    }

    /* í…ìŠ¤íŠ¸ íš¨ê³¼ */
    #privacyNotice.scrambled {
      filter: blur(4px);
      user-select: none;
    }
    #privacyNotice {
      transition: filter 0.5s ease;
    }
    
    /* ì¸íŠ¸ë¡œ & ì—”ë”© í™”ë©´ */
    .game-screen {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      animation: screen-fade-in 1s forwards;
    }
    @keyframes screen-fade-in {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .game-button {
      background: var(--highlight-color);
      transition: all 0.3s ease;
    }
    .game-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    /* ê¸°íƒ€ ìŠ¤íƒ€ì¼ */
    .input-field:focus { box-shadow: 0 0 0 3px var(--highlight-color); border-color: var(--highlight-color); }
    .seg-active { background: var(--highlight-color); border-color: var(--highlight-color); }
    .btn-submit { background: var(--highlight-color); }
    .gradient-bg { background: linear-gradient(135deg, var(--story-header-start) 0%, var(--story-header-end) 100%); }
    .text-primary { color: var(--primary-text); }
    .text-secondary { color: var(--secondary-text); }
    .highlight-text { color: var(--highlight-color); }
    .true-ending-theme #storyHeader { background: linear-gradient(135deg, var(--story-header-start) 0%, var(--story-header-end) 100%); }

  </style>
</head>
<body class="min-h-screen">

  <!-- ================================== -->
  <!--           ê²Œì„ í™”ë©´ë“¤               -->
  <!-- ================================== -->

  <!-- ì¸íŠ¸ë¡œ í™”ë©´ -->
  <div id="introScreen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="game-screen w-full max-w-2xl text-center p-8 md:p-12 rounded-3xl shadow-2xl">
      <div class="text-6xl mb-4">ğŸ“œ</div>
      <h1 class="text-4xl font-bold text-primary mb-3">ëŠ˜ë´„ ì´ì•¼ê¸°: ì‚¬ê³„ì ˆì˜ ë¹„ë°€</h1>
      <p class="text-lg text-secondary mb-8">ì´ê²ƒì€ í‰ë²”í•œ ì‹ ì²­ì„œê°€ ì•„ë‹™ë‹ˆë‹¤.<br>í•œ ì•„ì´ì˜ ì†Œì¤‘í•œ ì—¬ì •ì„ ì™„ì„±í•˜ëŠ” ë§ˆë²•ì˜ ì‹œí—˜ì…ë‹ˆë‹¤.</p>
      <button id="startGameBtn" class="game-button text-white font-bold text-xl px-12 py-4 rounded-full shadow-lg">
        ì‹œí—˜ ì‹œì‘í•˜ê¸°
      </button>
    </div>
  </div>

  <!-- ì¼ë°˜ ì—”ë”©: ì…í•™ í—ˆê°€ì„œ -->
  <div id="admissionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="game-screen w-full max-w-2xl text-center p-8 md:p-12 rounded-3xl shadow-2xl">
      <div class="text-6xl mb-4 animate-bounce">ğŸ‰</div>
      <h1 class="text-4xl font-bold text-primary mb-3">ì…í•™ì„ ì¶•í•˜í•©ë‹ˆë‹¤!</h1>
      <p class="text-lg text-secondary mb-6">
        <span id="admissionStudentName" class="font-bold highlight-text"></span> í•™ìƒì˜ ëŠ˜ë´„í•™êµ ì…í•™ì´ í—ˆê°€ë˜ì—ˆìŠµë‹ˆë‹¤.
      </p>
      <div class="bg-white/70 p-4 rounded-xl text-left text-sm text-primary shadow-inner">
        <h3 class="font-bold text-center mb-2">ì™„ì„±ëœ ì‹œê°„í‘œ</h3>
        <div id="admissionTimetable" class="text-xs"></div>
      </div>
      <button onclick="location.reload()" class="game-button mt-8 text-white font-bold px-8 py-3 rounded-full shadow-lg">
        ë‹¤ì‹œí•˜ê¸°
      </button>
    </div>
  </div>
  
  <!-- ================================== -->
  <!--         ë©”ì¸ ê²Œì„ í¼ (ê¸°ì¡´ í¼)       -->
  <!-- ================================== -->
  <div id="mainForm" class="hidden container mx-auto max-w-4xl p-4 sm:p-6 py-8">
    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl p-6 sm:p-10">
      <div class="text-center mb-8">
        <h1 id="formTitle" class="text-3xl sm:text-4xl font-bold text-primary">ëŠ˜ë´„ ë§ˆë²•í•™êµ ì…í•™ì‹œí—˜</h1>
        <p id="formDesc" class="text-secondary mt-2">ê° ì¥ì— ìˆ¨ê²¨ì§„ ë¹„ë°€ì„ í’€ê³  ì•„ì´ì˜ ì—¬ì •ì„ ì™„ì„±í•˜ì„¸ìš”.</p>
      </div>

      <div id="serverMsg" class="hidden mt-4 p-4 rounded-xl text-sm"></div>

      <form id="form" class="mt-8 space-y-10" autocomplete="off" novalidate onsubmit="return false;">
        
        <!-- ìŠ¤í…Œì´ì§€ 1: ì‹ ë¢°ì˜ ì„œì•½ -->
        <section id="stage-1" class="stage space-y-4 p-6 rounded-2xl bg-white/50 relative">
          <div class="flex items-start gap-3">
            <div id="privacyLock" class="text-4xl cursor-pointer transition-transform hover:scale-110">ğŸ”’</div>
            <div class="flex-1">
              <h2 class="text-xl font-bold text-primary mb-3">ì œ 1ì¥: ì‹ ë¢°ì˜ ì„œì•½</h2>
              <div id="privacyNotice" class="text-sm text-gray-700 bg-white p-4 rounded-lg mb-4 whitespace-pre-line scrambled">
                ë³¸ ì„¤ë¬¸ì€ ëŠ˜ë´„í•™êµ ìš´ì˜ì„ ìœ„í•´ ìµœì†Œí•œì˜ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤. ìˆ˜ì§‘ëœ ì •ë³´ëŠ” í”„ë¡œê·¸ë¨ ë°°ì • ë° ì—°ë½ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
              </div>
              <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="privacyAgree" class="mt-1 w-6 h-6 rounded border-gray-300 text-pink-600 focus:ring-pink-500">
                <span class="text-sm font-semibold text-primary">ì´ ì„œì•½ì€ ì•„ì´ì˜ ì ì¬ë ¥ì„ ìµœìš°ì„ ìœ¼ë¡œ ë³´í˜¸í•˜ê² ë‹¤ëŠ” í•™êµì˜ ì•½ì†ì„ì„ ì´í•´í•˜ê³  ë™ì˜í•©ë‹ˆë‹¤.</span>
              </label>
            </div>
          </div>
        </section>

        <!-- ìŠ¤í…Œì´ì§€ 2: ìš´ëª…ì˜ ê°ˆë¦¼ê¸¸ -->
        <section id="stage-2" class="stage hidden relative space-y-4 p-6 rounded-2xl bg-white/50">
          <div class="stage-locked"></div>
          <h2 class="text-xl font-bold text-primary">ì œ 2ì¥: ìš´ëª…ì˜ ê°ˆë¦¼ê¸¸</h2>
          <div class="grid grid-cols-2 gap-3">
            <button type="button" data-student-type="new" class="student-type-btn seg w-full p-4 rounded-xl font-semibold flex items-center justify-center gap-2">
              <span class="text-2xl">ğŸŒ±</span>
              <span>ìƒˆì‹¹ì˜ ê¸¸ (ì‹ ì…ìƒ)</span>
            </button>
            <button type="button" data-student-type="existing" class="student-type-btn seg w-full p-4 rounded-xl font-semibold text-gray-700 flex items-center justify-center gap-2">
              <span class="text-2xl">ğŸ“š</span>
              <span>ê³„ìŠ¹ì˜ ê¸¸ (ê¸°ì¡´í•™ìƒ)</span>
            </button>
          </div>
        </section>

        <!-- ìŠ¤í…Œì´ì§€ 3: ì˜ì›…ì˜ ì—°ëŒ€ê¸° -->
        <section id="stage-3" class="stage hidden relative space-y-6 p-6 rounded-2xl bg-white/50">
          <div class="stage-locked"></div>
          <h2 class="text-xl font-bold text-primary">ì œ 3ì¥: ì˜ì›…ì˜ ì—°ëŒ€ê¸°</h2>
          <div id="studentInfoContainer" class="hidden">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">íƒ„ìƒì˜ ìˆœê°„ (ìƒë…„ì›”ì¼)</label>
                <input type="date" id="birthDate" class="input-field mt-1 block w-full px-3 py-2 rounded-xl border-gray-300">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ì˜ì›…ì˜ ì´ë¦„ (í•™ìƒ ì´ë¦„)</label>
                <input type="text" id="studentName" placeholder="ì•„ì´ì˜ ì´ë¦„ì„ ì†ì‚­ì—¬ì£¼ì„¸ìš”" class="input-field mt-1 block w-full px-3 py-2 rounded-xl border-gray-300">
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 pt-4 mt-4 border-t">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ìˆ˜í˜¸ìì˜ ì´ë¦„ (í•™ë¶€ëª¨ ì´ë¦„)</label>
                <input type="text" id="parentNameInput" placeholder="ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì•Œë ¤ì£¼ì„¸ìš”" class="input-field mt-1 block w-full px-3 py-2 rounded-xl border-gray-300">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ìˆ˜í˜¸ìì˜ ì—°ë½ ë§ˆë²• (ì—°ë½ì²˜)</label>
                <input type="tel" id="parentContactInput" placeholder="010-XXXX-XXXX" class="input-field mt-1 block w-full px-3 py-2 rounded-xl border-gray-300">
                <p class="text-xs text-gray-500 mt-1">íŒíŠ¸: ì„¸ìƒì—ì„œ ê°€ì¥ ë”°ëœ»í•œ ë§ˆë²•ì˜ ìˆ«ìëŠ” '1004'ì…ë‹ˆë‹¤.</p>
              </div>
            </div>
          </div>
        </section>
        
        <!-- ìŠ¤í…Œì´ì§€ 4: ì§€í˜œì˜ ì‹œê°„í‘œ -->
        <section id="stage-4" class="stage hidden relative space-y-4 p-6 rounded-2xl bg-white/50">
          <div class="stage-locked"></div>
          <h2 class="text-xl font-bold text-primary">ì œ 4ì¥: ì§€í˜œì˜ ì‹œê°„í‘œ</h2>
          <div class="bg-purple-100/50 p-3 rounded-lg text-center text-secondary font-semibold text-sm">
            "ì›”ìš”ì¼ì—” <span class="highlight-text">ëŒë³´ëŠ” ë§ˆìŒ</span>, ìˆ˜ìš”ì¼ì—” <span class="highlight-text">ë§ì¶¤í˜• ì§€í˜œ</span>, ê¸ˆìš”ì¼ì—” <span class="highlight-text">ìƒˆë¡œìš´ êµìœ¡</span>ì˜ ì”¨ì•—ì„ ì‹¬ìœ¼ì„¸ìš”."
          </div>
          <div id="timetable" class="overflow-x-auto bg-gray-50/50 p-4 rounded-2xl shadow-inner"></div>
        </section>

        <!-- ìŠ¤í…Œì´ì§€ 5: ìˆ˜í˜¸ì ì—°ë§¹ -->
        <section id="stage-5" class="stage hidden relative space-y-4 p-6 rounded-2xl bg-white/50">
          <div class="stage-locked"></div>
          <h2 id="companionTitle" class="text-xl font-bold text-primary">ì œ 5ì¥: ìˆ˜í˜¸ì ì—°ë§¹</h2>
          <p id="companionDesc" class="text-sm text-secondary bg-purple-100/50 p-3 rounded-lg">"ì•„ì´ì˜ ê°€ì¥ ë“ ë“ í•œ ì²« ë²ˆì§¸ ìˆ˜í˜¸ìëŠ” ë°”ë¡œ ë‹¹ì‹ ì…ë‹ˆë‹¤. ì²« ë²ˆì§¸ ê³„ì•½ì„œì— ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì„œëª…í•˜ì‹­ì‹œì˜¤."</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div class="p-4 bg-blue-50/50 rounded-xl">
              <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ‘¤ ì²« ë²ˆì§¸ ê³„ì•½ (ë™í–‰ì1 ì´ë¦„)</label>
              <input id="companion1Name" class="input-field w-full px-3 py-2 rounded-lg border-gray-300">
            </div>
            <div class="p-4 bg-purple-50/50 rounded-xl">
              <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ‘¤ ë‘ ë²ˆì§¸ ê³„ì•½ (ë™í–‰ì2 ì´ë¦„)</label>
              <input id="companion2Name" class="input-field w-full px-3 py-2 rounded-lg border-gray-300">
            </div>
          </div>
        </section>

        <!-- ìµœì¢… ì œì¶œ ë²„íŠ¼ -->
        <div id="submit-container" class="pt-4 flex justify-center hidden">
          <button id="btn-submit" type="submit" class="btn-submit w-full sm:w-auto px-10 py-4 font-bold text-lg rounded-xl text-white shadow-xl transition-all duration-500">
            âœ… ì…í•™ ì‹ ì²­ì„œ ì œì¶œí•˜ê¸°
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ì´ìŠ¤í„°ì—ê·¸ ëª¨ë‹¬ (ê¸°ì¡´ ì½”ë“œ ì¬í™œìš©) -->
  <div id="easterEggModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm items-center justify-center z-50 p-4">
    <!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ë‚´ìš© ìƒì„± -->
  </div>

<script>
// ==================================
//         ê²Œì„ ìƒíƒœ ë° ì„¤ì •
// ==================================
const gameState = {
  currentStage: 0,
  isTrueEndingPath: false,
  studentName: '',
  parentName: '',
  timetableRiddle: { mon: false, wed: false, fri: false },
};

const sounds = {
  start: new Audio("https://cdn.pixabay.com/download/audio/2022/03/10/audio_291885ea0c.mp3?filename=fantasy-magical-sweep-swoosh-1-101 sweep.wav"),
  unlock: new Audio("https://cdn.pixabay.com/download/audio/2021/08/04/audio_dea41b359c.mp3?filename=magic-wand-1-101 wand.wav"),
  success: new Audio("https://cdn.pixabay.com/download/audio/2022/01/21/audio_ea3b022213.mp3?filename=success-1-6297.mp3"),
  sparkle: new Audio("https://cdn.pixabay.com/download/audio/2022/03/10/audio_c29d3bce2e.mp3?filename=fantasy-magical-sparkle-swoosh-1-101 sparkle.wav"),
  trueEnding: new Audio("https://cdn.pixabay.com/download/audio/2022/11/17/audio_855845ce37.mp3?filename=a-small-miracle-120390.mp3"),
};
Object.values(sounds).forEach(sound => sound.volume = 0.5);

// ==================================
//         ê²Œì„ í•µì‹¬ ë¡œì§
// ==================================
document.addEventListener('DOMContentLoaded', () => {
  // ì¸íŠ¸ë¡œ ì‹œì‘ ë²„íŠ¼
  document.getElementById('startGameBtn').addEventListener('click', () => {
    playSound('start');
    document.getElementById('introScreen').classList.add('hidden');
    document.getElementById('mainForm').classList.remove('hidden');
    showStage(1);
  });
  
  initStage1();
  initStage2();
  initStage3();
  initStage4();
  initStage5();

  document.getElementById('form').addEventListener('submit', handleFormSubmit);
});

function playSound(soundName) {
  if (sounds[soundName]) {
    sounds[soundName].currentTime = 0;
    sounds[soundName].play();
  }
}

function showStage(stageNumber) {
  if (stageNumber <= gameState.currentStage) return;
  gameState.currentStage = stageNumber;
  
  const stageEl = document.getElementById(`stage-${stageNumber}`);
  if (stageEl) {
    stageEl.classList.remove('hidden');
    // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ì˜ ì ê¸ˆ í•´ì œ ì• ë‹ˆë©”ì´ì…˜
    const lockEl = stageEl.querySelector('.stage-locked');
    if(lockEl) {
      setTimeout(() => {
        playSound('unlock');
        lockEl.classList.remove('stage-locked');
        lockEl.classList.add('stage-unlocked');
      }, 300);
    }
  }
}

// ==================================
//         ìŠ¤í…Œì´ì§€ë³„ ì´ˆê¸°í™”
// ==================================

// --- ìŠ¤í…Œì´ì§€ 1: ì‹ ë¢°ì˜ ì„œì•½ ---
function initStage1() {
  const notice = document.getElementById('privacyNotice');
  const originalText = notice.textContent;
  notice.textContent = scrambleText(originalText);

  document.getElementById('privacyLock').addEventListener('click', () => {
    playSound('unlock');
    notice.classList.remove('scrambled');
    notice.textContent = originalText;
  });

  document.getElementById('privacyAgree').addEventListener('change', (e) => {
    if (e.target.checked && !notice.classList.contains('scrambled')) {
      playSound('success');
      showStage(2);
    } else if (e.target.checked) {
      alert("ì„œì•½ì˜ ë‚´ìš©ì„ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”. (ğŸ”’ ìë¬¼ì‡ ë¥¼ í´ë¦­!)");
      e.target.checked = false;
    }
  });
}

// --- ìŠ¤í…Œì´ì§€ 2: ìš´ëª…ì˜ ê°ˆë¦¼ê¸¸ ---
function initStage2() {
  document.querySelectorAll('.student-type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.student-type-btn').forEach(b => b.classList.remove('seg-active'));
      btn.classList.add('seg-active');
      document.getElementById('studentInfoContainer').classList.remove('hidden');
      playSound('success');
      showStage(3);
    });
  });
}

// --- ìŠ¤í…Œì´ì§€ 3: ì˜ì›…ì˜ ì—°ëŒ€ê¸° ---
function initStage3() {
  const studentNameInput = document.getElementById('studentName');
  const parentNameInput = document.getElementById('parentNameInput');
  const contactInput = document.getElementById('parentContactInput');

  studentNameInput.addEventListener('input', () => {
    gameState.studentName = studentNameInput.value.trim();
    if (gameState.studentName === 'ê¹€ì •ì„¤' && !gameState.isTrueEndingPath) {
      gameState.isTrueEndingPath = true;
      playSound('sparkle');
      createSparkles(studentNameInput);
      sounds.trueEnding.loop = true;
      sounds.trueEnding.volume = 0.3;
      sounds.trueEnding.play();
    }
    checkStage3Completion();
  });
  
  parentNameInput.addEventListener('input', () => {
    gameState.parentName = parentNameInput.value.trim();
    checkStage3Completion();
  });

  contactInput.addEventListener('input', () => {
    contactInput.value = formatPhoneNumber(contactInput.value);
    checkStage3Completion();
  });
}

function checkStage3Completion() {
  const isComplete = gameState.studentName && gameState.parentName && document.getElementById('parentContactInput').value.includes('1004');
  if (isComplete && gameState.currentStage < 4) {
    playSound('success');
    showStage(4);
  }
}

// --- ìŠ¤í…Œì´ì§€ 4: ì§€í˜œì˜ ì‹œê°„í‘œ ---
function initStage4() {
  renderTimetable();
  const timetableEl = document.getElementById('timetable');
  timetableEl.addEventListener('change', (e) => {
    if(e.target.tagName === 'SELECT') {
      const day = e.target.dataset.day;
      const value = e.target.value;

      if (day === 'ì›”' && value.includes('ëŒë´„')) gameState.timetableRiddle.mon = true;
      if (day === 'ìˆ˜' && value.includes('ë§ì¶¤í˜•')) gameState.timetableRiddle.wed = true;
      if (day === 'ê¸ˆ' && value.includes('êµìœ¡')) gameState.timetableRiddle.fri = true;
      
      checkStage4Completion();
    }
  });
}

function checkStage4Completion() {
  const { mon, wed, fri } = gameState.timetableRiddle;
  if (mon && wed && fri && gameState.currentStage < 5) {
    playSound('success');
    showStage(5);
  }
}

// --- ìŠ¤í…Œì´ì§€ 5: ìˆ˜í˜¸ì ì—°ë§¹ ---
function initStage5() {
    const companion1Input = document.getElementById('companion1Name');
    companion1Input.addEventListener('input', () => {
        const companionName = companion1Input.value.trim();
        let isComplete = false;

        if (gameState.isTrueEndingPath) {
            if (companionName === 'ì†ì§€í›ˆ') {
                isComplete = true;
                // ì§„ì—”ë”© ë£¨íŠ¸ í™•ì •
                document.body.classList.add('true-ending-theme');
                createSparkles(document.body);
                document.getElementById('companionTitle').textContent = "ì œ 5ì¥: Hì˜ ì•½ì†";
                document.getElementById('companionDesc').innerHTML = `"...ì°¾ìœ¼ì…¨êµ°ìš”. <span class='font-bold'>Sì˜ ì´ì•¼ê¸°</span> ê³ì—ëŠ” ì–¸ì œë‚˜ <span class='font-bold'>Hê°€</span> ìˆë‹¤ëŠ” ê²ƒì„."`;
                document.getElementById('btn-submit').textContent = "ğŸ“œ ì´ì•¼ê¸° ì™„ì„±í•˜ê¸°";
            }
        } else {
            if (companionName && companionName === gameState.parentName) {
                isComplete = true;
            }
        }

        if (isComplete) {
            playSound('success');
            document.getElementById('submit-container').classList.remove('hidden');
        }
    });
}


// --- ìµœì¢… ì œì¶œ ì²˜ë¦¬ ---
function handleFormSubmit(e) {
  e.preventDefault();
  if (gameState.isTrueEndingPath) {
    showTrueEnding();
  } else {
    showNormalEnding();
  }
}

// ==================================
//              ì—”ë”©
// ==================================

function showNormalEnding() {
  sounds.trueEnding.pause();
  playSound('success');
  
  document.getElementById('admissionStudentName').textContent = gameState.studentName;
  const timetableHTML = document.getElementById('timetable').querySelector('table').outerHTML;
  document.getElementById('admissionTimetable').innerHTML = timetableHTML;
  
  document.getElementById('mainForm').classList.add('hidden');
  document.getElementById('admissionModal').classList.remove('hidden');
}

function showTrueEnding() {
  const story = {
      chapters: [
          { season: "í”„ë¡¤ë¡œê·¸", emoji: "ğŸ’Œ", color: "from-pink-300 to-yellow-200", text: `ì´ ì‘ì€ ì—¬ì •ì„ ì°¾ì•„ì£¼ì…”ì„œ ê³ ë§™ìŠµë‹ˆë‹¤.\n\në‹¹ì‹ ì´ ë°©ê¸ˆ ëë§ˆì¹œ ì´ ì…í•™ ì‹ ì²­ì„œëŠ”,\nHê°€ Së¥¼ ìœ„í•´ ë§Œë“  ìˆ˜ë§ì€ 'ì‚¬ê³„ì ˆì˜ ë¹„ë°€' ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.\n\nSê°€ ëŠ˜ ë´„ì²˜ëŸ¼ ë”°ëœ»í•œ ì„¸ìƒì—ì„œ í–‰ë³µí•˜ê¸°ë¥¼ ë°”ë¼ëŠ” ë§ˆìŒìœ¼ë¡œ,\nHëŠ” ì½”ë“œë¥¼ í†µí•´ ì‘ì€ ì„¸ìƒì„ ë§Œë“¤ê³ , ê·¸ ì•ˆì— ë‘˜ë§Œì˜ ì´ì•¼ê¸°ë¥¼ ìˆ¨ê²¨ë‘ì—ˆìŠµë‹ˆë‹¤.\n\nì´ì œ, ê·¸ ì´ì•¼ê¸°ì˜ ì§„ì§œ ì‹œì‘ì„ ë“¤ë ¤ë“œë¦´ê²Œìš”.`, image: "ğŸ’ŒğŸ“œğŸ’–" },
          { season: "ë´„", emoji: "ğŸŒ¸", color: "from-pink-300 to-yellow-200", text: `ì–´ëŠ ë´„ë‚ , ë‘ ì¹œêµ¬ Sì™€ HëŠ” íŠ¹ë³„í•œ ì„ë¬´ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.\n\n"ì‚¬ê³„ì ˆì´ ì™œ ìˆœì„œëŒ€ë¡œ ì˜¤ëŠ”ì§€ ì•„ë¬´ë„ ëª¨ë¥¸ë‹¤ëŠ” ê±°ì•¼!"\n\ní˜¸ê¸°ì‹¬ ë§ì€ Sê°€ ë…¸íŠ¸ë¶ì„ ì—´ì—ˆê³ ,\në”°ëœ»í•œ ë§ˆìŒì„ ê°€ì§„ Hê°€ ì•„ì´ë””ì–´ë¥¼ ëƒˆìŠµë‹ˆë‹¤.\n\n"ìš°ë¦¬ê°€ ì§ì ‘ ì•Œì•„ë‚´ë³´ì!"`, image: "ğŸŒ¸ğŸ’»ğŸŒ±" },
          { season: "ì—¬ë¦„", emoji: "â˜€ï¸", color: "from-yellow-300 to-orange-200", text: `ëœ¨ê±°ìš´ ì—¬ë¦„, ë‘ ì¹œêµ¬ëŠ” ì½”ë“œì˜ ë°”ë‹¤ë¥¼ í—¤ì—„ì³¤ìŠµë‹ˆë‹¤.\n\në°¤ë‚®ì—†ì´ í‚¤ë³´ë“œë¥¼ ë‘ë“œë¦¬ë©°,\ní•œ ì¤„ í•œ ì¤„ í”„ë¡œê·¸ë¨ì„ ë§Œë“¤ì–´ê°”ì–´ìš”.\n\n"ëŠ˜ë´„í†¡í†¡"ì´ë¼ëŠ” ì´ë¦„ë„ ì´ë•Œ íƒ„ìƒí–ˆìŠµë‹ˆë‹¤.\nëŠ˜ ë´„ì²˜ëŸ¼ ë”°ëœ»í•œ ë§ˆìŒìœ¼ë¡œ ì•„ì´ë“¤ì„ ëŒë³´ëŠ”...`, image: "â˜€ï¸ğŸŠâ€â™‚ï¸ğŸ’ª" },
          { season: "ê°€ì„", emoji: "ğŸ‚", color: "from-orange-300 to-red-200", text: `ë‚™ì—½ì´ ë–¨ì–´ì§€ëŠ” ê°€ì„, ë“œë””ì–´ ë¹„ë°€ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!\n\nì‚¬ê³„ì ˆì˜ ìˆœí™˜ì€... ë°”ë¡œ 'ë³€í™”'ì™€ 'ì„±ì¥'!\në´„ì˜ ì„¤ë ˜, ì—¬ë¦„ì˜ ì—´ì •, ê°€ì„ì˜ ê²°ì‹¤, ê²¨ìš¸ì˜ ì¤€ë¹„.\n\nì•„ì´ë“¤ë„ ê³„ì ˆì²˜ëŸ¼ ìë¼ë‚˜ëŠ” ê±°ì˜ˆìš”.\n\n"ìš°ë¦¬ ì‹œìŠ¤í…œìœ¼ë¡œ ì•„ì´ë“¤ì˜ ì„±ì¥ì„ ë•ì!"`, image: "ğŸ‚ğŸ”âœ¨" },
          { season: "ê²¨ìš¸", emoji: "â„ï¸", color: "from-blue-300 to-purple-200", text: `ì°¨ê°€ìš´ ê²¨ìš¸, ëŠ˜ë´„í†¡í†¡ì´ ì„¸ìƒì— ë‚˜ì™”ìŠµë‹ˆë‹¤.\n\nSì™€ HëŠ” í•˜ì–€ ëˆˆì„ ë°”ë¼ë³´ë©° ìƒê°í–ˆì£ .\n\n"ê²¨ìš¸ì´ ìˆì–´ì•¼ ë´„ì´ ë” ì•„ë¦„ë‹¤ìš´ ê²ƒì²˜ëŸ¼,\nìš°ë¦¬ì˜ ë…¸ë ¥ì´ ìˆì–´ì•¼ ì•„ì´ë“¤ì˜ ë¯¸ë˜ê°€ ë¹›ë‚  ê±°ì•¼."\n\nê·¸ë ‡ê²Œ ëŠ˜ë´„í†¡í†¡ì€...`, image: "â„ï¸ğŸğŸŒŸ" },
          { season: "ë‹¤ì‹œ ë´„", emoji: "ğŸŒˆ", color: "from-purple-300 via-pink-300 to-yellow-200", text: `ê³„ì ˆì€ ëŒê³  ëŒì•„ ë‹¤ì‹œ ë´„ì´ ì™”ìŠµë‹ˆë‹¤.\n\nëŠ˜ë´„í†¡í†¡ ë•ë¶„ì— ë§ì€ ì•„ì´ë“¤ì´\ní–‰ë³µí•œ ë°©ê³¼í›„ë¥¼ ë³´ë‚´ê³  ìˆì–´ìš”.\n\nSì™€ Hì˜ ì—¬ì •ì€ ê³„ì†ë©ë‹ˆë‹¤.\nì‚¬ê³„ì ˆì²˜ëŸ¼, ëì—†ì´ ìˆœí™˜í•˜ë©° ì„±ì¥í•˜ëŠ”...\n\nğŸ’ ì§€ê¸ˆ ì´ ìˆœê°„ë„, ì–´ë”˜ê°€ì—ì„œ\në‘ ì¹œêµ¬ëŠ” ë” ë‚˜ì€ ì‹œìŠ¤í…œì„ ê¿ˆê¾¸ê³  ìˆë‹µë‹ˆë‹¤.`, image: "ğŸŒˆğŸ“ğŸ’–" }
      ]
  };
  let currentChapter = 0;
  
  const modal = document.getElementById('easterEggModal');
  modal.innerHTML = `
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <div id="storyHeader" class="p-6 text-center transition-all duration-500">
        <h2 class="text-2xl font-bold text-gray-800"></h2>
        <p class="text-sm text-gray-700"></p>
      </div>
      <div id="storyContent" class="flex-1 overflow-auto p-8 text-center"></div>
      <div class="border-t p-4 bg-gray-50 flex justify-between items-center">
        <button id="prevChapter" class="px-5 py-2 rounded-lg border-2 font-semibold transition disabled:opacity-30">â† ì´ì „</button>
        <div id="chapterIndicator" class="text-sm font-semibold"></div>
        <button id="nextChapter" class="px-5 py-2 rounded-lg bg-pink-500 text-white font-semibold shadow-lg">ë‹¤ìŒ â†’</button>
      </div>
    </div>`;
  
  const render = () => {
    const chapter = story.chapters[currentChapter];
    modal.querySelector('#storyHeader').className = `p-6 text-center transition-all duration-500 bg-gradient-to-r ${chapter.color}`;
    modal.querySelector('#storyHeader h2').textContent = `ğŸŒ¸ ${chapter.season}`;
    modal.querySelector('#storyContent').innerHTML = `<div class="text-6xl mb-4">${chapter.image}</div><div class="text-lg text-gray-700 leading-relaxed whitespace-pre-line">${chapter.text}</div>`;
    modal.querySelector('#chapterIndicator').textContent = `${currentChapter + 1} / ${story.chapters.length}`;
    modal.querySelector('#prevChapter').disabled = currentChapter === 0;
    
    if (currentChapter === story.chapters.length - 1) {
        modal.querySelector('#nextChapter').textContent = "ì´ì•¼ê¸° ë‹«ê¸°";
    } else {
        modal.querySelector('#nextChapter').textContent = "ë‹¤ìŒ â†’";
    }
  };

  modal.querySelector('#nextChapter').addEventListener('click', () => {
    if (currentChapter < story.chapters.length - 1) {
      currentChapter++;
      render();
    } else {
      location.reload();
    }
  });
  modal.querySelector('#prevChapter').addEventListener('click', () => {
    if (currentChapter > 0) {
      currentChapter--;
      render();
    }
  });

  render();
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

// ==================================
//         ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// ==================================

function scrambleText(text) {
  return text.split('').map(char => {
    if (char.match(/[ê°€-í£]/)) {
      return String.fromCharCode(0xAC00 + Math.floor(Math.random() * 11172));
    }
    return char;
  }).join('');
}

function formatPhoneNumber(value) {
  return value.replace(/[^\d]/g, '').replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
}

function createSparkles(element) {
  const rect = element.getBoundingClientRect();
  for (let i = 0; i < 20; i++) {
    const sparkle = document.createElement('span');
    sparkle.className = 'sparkle';
    const size = Math.random() * 5 + 2;
    sparkle.style.width = `${size}px`;
    sparkle.style.height = `${size}px`;
    sparkle.style.top = `${rect.top + rect.height / 2}px`;
    sparkle.style.left = `${rect.left + rect.width / 2}px`;
    sparkle.style.setProperty('--tx', `${(Math.random() - 0.5) * 100}px`);
    sparkle.style.setProperty('--ty', `${(Math.random() - 0.5) * 100}px`);
    document.body.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 800);
  }
}

function renderTimetable() {
  const subjects = ['ì„ íƒí˜• ëŒë´„', 'ë§ì¶¤í˜•', 'ì„ íƒí˜• êµìœ¡(ì˜ˆì •)'];
  let html = `<table class="table-fixed w-full text-xs text-center"><thead><tr class="text-secondary"><th></th>${['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;
  for (let i=1; i<=3; i++) {
    html += `<tr><td class="font-semibold text-secondary p-1">${i}êµì‹œ</td>`;
    html += ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].map(d => `
      <td class="p-1"><select data-day="${d}" class="w-full p-1 rounded border-gray-300 text-xs">
        <option value="">-</option>
        ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
      </select></td>
    `).join('');
    html += '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById('timetable').innerHTML = html;
}
</script>
</body>
</html>